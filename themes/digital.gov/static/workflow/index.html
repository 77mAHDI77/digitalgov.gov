<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <link rel="stylesheet" type="text/css" href="index.css" />
  </head>
  <body>
    <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
    <script src="https://unpkg.com/netlify-cms-widget-async-select@1.3.4"></script>
    <script type="module">
      import { formatDate, slugify } from "./helpers.js";

      CMS.registerEventListener({
        name: "preSave",
        handler: ({ entry }) => {
          const primary_image = entry.getIn(["data", "primary_image"]) || "";
          let data = entry.get("data");

          if (!entry.get("slug")) {
            data = data.set(
              "slug",
              slugify(
                entry.getIn(["data", "title"]) ||
                  entry.getIn(["data", "display_name"]) ||
                  entry.getIn(["data", "name"])
              )
            );
          }

          switch (entry.get("collection")) {
            case "events":
              data = data
                .set("date", formatDate(entry.getIn(["data", "cms_date"])))
                .set(
                  "end_date",
                  formatDate(entry.getIn(["data", "cms_end_date"]))
                )
                .set("primary_image", primary_image.replace(/\.[^/.]+$/, ""));

            case "news":
              data = data
                .set("date", formatDate(entry.getIn(["data", "cms_date"])))
                .set("primary_image", primary_image.replace(/\.[^/.]+$/, ""));
          }

          return data;
        }
      });

      CMS.registerWidget("async-select", window.AsyncSelectControl);

      window.addEventListener("hashchange", function(e) {
        var body = document.querySelector("body");
        window.location.hash.indexOf("#/collections/image-upload/new") > -1
          ? body.classList.add("show-upload")
          : body.classList.remove("show-upload");
      });
      window.dispatchEvent(new HashChangeEvent("hashchange"));
    </script>
  </body>
</html>
