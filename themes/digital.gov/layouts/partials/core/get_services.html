{{/*
  ======================================
  Services Promos (for articles)
  ======================================
*/}}

{{/* Gets the get_topics associated with this post */}}
{{ $post_topics := .Params.topics }}

{{/* IMPORTANT */}}
{{/* This is an empty array (a.k.a. slice) */}}
{{ $.Scratch.Set "related_services" (slice " ") }}

{{/* For each topic in the post... */}}
{{ range $i, $topic := $post_topics }}

  {{/* Get all the services */}}
  {{ $services := $.Site.GetPage "page" "services" }}
  {{/* {{ $communities }} */}}
  {{ $services := (where $.Site.Pages "Section" "services") }}
  {{/* Get all the services WHERE page weight == 3 */}}
  {{/* {{ $services := where ($services.Resources.ByType "page") ".Params.weight" 3 }} */}}
  {{/* If there are any services */}}
  {{ with $services }}

    {{/* For each services */}}
    {{ range $i, $e := $services }}
      {{/* get the topic associated with the services */}}
      {{ $service_topics := .Params.topics }}

      {{/* If the $topic is in one of these services,... */}}
      {{/* display the services */}}
      {{ if in $service_topics $topic }}

      {{/* This appends/adds the .File.LogicalName to the array */}}
      {{ $.Scratch.Add "related_services" (slice .File.LogicalName ) }}

      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Removes the duplicate file names in the array */}}
{{ $related_services := uniq ($.Scratch.Get "related_services") }}

{{ if $related_services }}
  {{/* If there are related services... */}}
  {{ if gt (len $related_services) 1 }}
  <section id="related_services">

    <header>
      <h3>Get Started Building</h3>
    </header>

    {{/* Let's loop through the service pages that have similar topics! */}}
    {{ range $i, $e := $related_services }}

      {{/* Finally we can get the services/pages and their data */}}
      {{ with $.Site.GetPage (print "/services/" $e) }}
        <article class="promo">
          <div class="grid-row">
            <div class="grid-col-9 display-flex flex-align-center">
              <h3><a href="{{ .Permalink }}?promo" title="{{ .Title }}">{{ .Title }}</a></h3>
            </div>
            <div class="grid-col-3 display-flex flex-align-center">
              {{- if .Params.members -}}
              <p class="members"><i class="fas fa-user"></i>&nbsp;{{- .Params.members -}}</p>
              {{- end -}}
            </div>
          </div>
          <a href="{{ .Params.url }}?dg" title="{{ .Params.head }}"><span></span></a>
        </article>
      {{ end }}

    {{ end }}

    <footer>
      <h5><a href="{{ "/services/" | absURL }}">See all {{ len (where .Site.Pages "Section" "services") }} services <i class="fas fa-arrow-alt-circle-right"></i></a></h5>
    </footer>
  </section>
  {{ end }}
{{ end }}
