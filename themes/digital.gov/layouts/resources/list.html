{{- define "content" -}}

<main id="resources" role="main">
  <article>
    <header class="page-head page-head-{{- .Type -}}">
      <div class="grid-container grid-container-desktop">
        <div class="grid-row">
          <div class="grid-col-12" data-edit-this="/edit/{{- .Type -}}/?page=https://digital.gov{{- (urls.Parse .Permalink).Path -}}">

            {{/* Page Title */}}
            <h1>{{- .Title | markdownify -}} </h1>

            {{/* Deck */}}
            {{- if .Params.deck -}}
            <div class="deck">{{- .Params.deck | markdownify | emojify -}}</div>
            {{- end -}}

            {{/* {{ partial "last-updated" . }} */}}
          </div>
        </div>

        <div class="grid-row">
          <div class="grid-col-12">

            {{- partial "core/search-bar.html" . -}}

          </div>
        </div>

      </div>
    </header>


    {{/* Popular Resources */}}
    <section class="usa-section" id="resources_featured">
      <div class="grid-container grid-container-desktop">
        <div class="grid-row">
          <div class="grid-col-12 tablet-lg:grid-col-10">

            {{/* Get the all the resources */}}
            {{- $resources := where .Site.Pages "Section" "resources" -}}
            {{/* Get the all the resources with weight greater than or equal to 3 */}}
            {{- $resources_featured := (where $resources ".Params.weight" "ge" 3) -}}
            {{/* Get the all the links */}}
            {{- $links := (where .Site.Pages "Section" "links") -}}
            {{/* Get the all the links with weight greater than or equal to 3 */}}
            {{- $links_featured := (where $links ".Params.weight" "ge" 3) -}}
            {{/* Merges the $links_featured and the $resources_featured */}}
            {{- $stream_featured := union $resources_featured $links_featured -}}

            {{/* Pass $stream_featured to the collection template */}}
            {{- partial "core/collection" (dict "list" $stream_featured "heading" "Popular Guides and Resources") -}}

          </div>
        </div>
      </div>
    </section>


    {{/* Resources Listed by Topic */}}
    {{- $page := .Page -}}
    <section class="usa-section" id="resources_by_topic">
      <div class="grid-container grid-container-desktop">

        <div class="grid-row">
          <div class="grid-col-12">
            <h2>All Resources by Topic</h2>
          </div>
        </div>
        <div class="grid-row grid-gap-4">

          <div class="grid-col-12 tablet:grid-col-9">

              {{/* Gets all the pages in the /topics directory */}}
              {{- with ($.Site.GetPage (printf "/%s" "topics")) -}}

              {{/* Get only the pages that are greater than or equal to 2 */}}
              {{- $topics_featured := (where .Pages ".Params.weight" "ge" 2 ) -}}

              {{/* Loop through all the topics... */}}
              {{ range $name, $taxonomy := $topics_featured }}

                {{/* Get all resource pages with this current taxonomy */}}
                {{- $resources_by_topic := (where .Pages "Section" "resources") -}}

                {{/* Get all link pages with this current taxonomy */}}
                {{- $links_by_topic := (where .Pages "Section" "links") -}}
                {{/* Merges the $links_featured and the $resources_featured */}}
                {{- $stream_by_topic := union $resources_by_topic $links_by_topic -}}

                {{/* If there are resources... */}}
                {{- if $stream_by_topic -}}
                <div class="topic-section">
                  <div class="grid-row">
                    <div class="grid-col-12">
                      <h3 id="{{- path.Base .RelPermalink -}}"><a href="{{- .Permalink -}}">{{- .Title -}}</a></h3>
                    </div>
                  </div>
                  <div class="grid-row">
                    <div class="grid-col-12 tablet-lg:grid-col-10">

                      {{/* Pass the $resources_by_topic to the collection template */}}
                      {{- partial "core/collection" (dict "list" $stream_by_topic) -}}

                    </div>
                  </div>
                  <footer>
                    <div class="grid-row">
                      <div class="grid-col-12">
                        <p class="more"><a href="{{- .Permalink -}}"><span>More on {{ .Title -}}</span> <i class="fas fa-arrow-circle-right"></i></a></p>
                      </div>
                    </div>
                  </footer>
                </div>
                {{- end -}}
              {{ end }}
            {{ end }}
          </div>

          <div class="grid-col-12 tablet:grid-col-3 tablet:order-first">
            <nav class="topics-sidebar">
              <ul>

                {{/* Gets all the pages in the /topics directory */}}
                {{- with ($.Site.GetPage (printf "/%s" "topics")) -}}

                  {{/* Get only the pages that are greater than or equal to 2 */}}
                  {{- $topics_featured := (where .Pages ".Params.weight" "ge" 2 ) -}}

                  {{/* Loop through all the topics... */}}
                  {{ range $name, $taxonomy := $topics_featured }}

                    {{/* Get all resource pages with this current taxonomy */}}
                    {{- $resources_by_topic := (where .Pages "Section" "resources") -}}
                    {{- if $resources_by_topic -}}
                      {{- $slug := .RelPermalink -}}
                      <li><a href="#{{- path.Base .RelPermalink -}}"><span>{{- .Title -}}</span></a></li>
                    {{- end -}}
                  {{- end -}}
                {{- end -}}

              </ul>
            </nav>
            <p class="more"><a href="{{- "/topics" | absURL -}}"><span>See all topics</span> <i class="fas fa-arrow-circle-right"></i></a></p>
          </div>

        </div>
      </div>
    </section>



    <section class="topic-buttons">
      <div class="grid-container grid-container-desktop">
        <div class="grid-row">
          <div class="grid-col-12">
            <h2>Resources by Topic</h2>
          </div>
        </div>
        <div class="grid-row tablet:grid-gap-2">
          {{- $top_topics := $.Site.Taxonomies.topics -}}
          {{- range $name, $taxonomy := $top_topics -}}
            {{- with $.Site.GetPage (printf "/topics/%s" $name) -}}
              {{- if or (eq .Params.weight 2) (eq .Params.weight 3) -}}
                <div class="grid-col-12 tablet:grid-col-4">
                  <div class="topic" data-edit-this="/edit/{{- .Type -}}/?page=https://digital.gov{{- (urls.Parse .Permalink).Path -}}">
                    <h3>
                      <a href="{{- .Permalink | absURL -}}" title="{{- .Title -}}">{{- .Title -}} <span>&#8594;</span></a>
                    </h3>
                  </div>
                </div>
              {{- end -}}
            {{- end -}}
          {{- end -}}
        </div>
        <footer>
          <div class="grid-row tablet-lg:grid-gap-2">
            <div class="grid-col-12">
              <p class="more"><a href="/topics"><span>See all topics</span> <i class="fas fa-arrow-circle-right"></i></a></p>
            </div>
          </div>
        </footer>
      </div>
    </section>

  </article>
</main>

{{- end -}}
